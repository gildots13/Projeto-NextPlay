<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="img/icone.png" type="image/x-icon">
    <link rel="stylesheet" href="css/style.css">
    <title>NextPlay - Home</title>
</head>
<body>
    <header>
        <a href="index.html" id="link-home">
            <div id="logo"><img src="./img/icone.png" alt=""></div>
            <div id="nome">NextPlay</div>
        </a>
        <div id="social-media">
            <a href="https://www.linkedin.com/in/gildojuniorab" target="_blank"><img src="./img/linkedin.svg" alt="LinkedIn"></a>
            <a href="https://github.com/gildots13" target="_blank"><img src="./img/github.svg" alt="GitHub"></a>
            <a href="https://www.instagram.com/gildo_ts13" target="_blank"><img src="./img/instagram.svg" alt="Instagram"></a>
        </div>
    </header>

    <main>
        <div class="container-principal">
            <h1 id="catalogo">Catálogo De Mídia</h1>
            <p id="navegue">Navegue pelas abas, avalie o que você já assistiu ou ouviu, e receba recomendaões abaixo!</p>

            <div class="nav-tabs">
                <button class="tab-button active" data-target="catalogo-filmes">Filmes</button>
                <button class="tab-button" data-target="catalogo-series">Séries</button>
                <button class="tab-button" data-target="catalogo-musicas">Músicas</button>
            </div>
            
            <div id="catalogo-filmes" class="catalogo-container active"></div>
            <div id="catalogo-series" class="catalogo-container"></div>
            <div id="catalogo-musicas" class="catalogo-container"></div>

            <h2 class="titulo-secao">Recomendações para Você</h2>
            <div id="recomendacoes-container"></div>
        </div>
    </main>

    <script>
        const API_BASE_URL = "https://nextplay-backend.onrender.com";
    document.addEventListener('DOMContentLoaded', function() {
        const usuarioId = sessionStorage.getItem('usuarioId');
        if (!usuarioId) {
            window.location.href = 'index.html';
            return;
        }

        const tabButtons = document.querySelectorAll('.tab-button');
        const catalogoContainers = document.querySelectorAll('.catalogo-container');
        
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                const targetId = button.dataset.target;
                catalogoContainers.forEach(container => container.style.display = 'none');
                
                const targetContainer = document.getElementById(targetId);
                targetContainer.style.display = 'grid';

                const tipo = targetId.split('-')[1];

                if (targetContainer.childElementCount === 0) {
                    if (tipo === 'filmes' || tipo === 'series') {
                        buscarEExibirCatalogo(tipo, usuarioId, targetContainer);
                    } else if (tipo === 'musicas') {
                        exibirArtistas(usuarioId, targetContainer);
                    }
                }
                
                buscarEExibirRecomendacoes(usuarioId, tipo); 
            });
        });

        document.querySelector('.tab-button[data-target="catalogo-filmes"]').click();
    });

    function buscarEExibirCatalogo(tipo, usuarioId, container) {
        container.innerHTML = `<p>Carregando ${tipo}...</p>`;
        fetch(`https://nextplay-backend.onrender.com/api/${tipo}`)
            .then(response => response.json())
            .then(items => {
                container.innerHTML = '';
                items.forEach(item => {
                    const card = (tipo === 'filmes') ? criarFilmeCard(item, usuarioId) : criarSerieCard(item, usuarioId);
                    container.appendChild(card);
                });
            });
    }

    function buscarEExibirRecomendacoes(usuarioId, tipo) {
        const container = document.getElementById('recomendacoes-container');
        const tipoEndpoint = tipo.replace('musicas', 'musica');
        container.innerHTML = `<p>Calculando recomendações de ${tipoEndpoint}...</p>`;
        
        fetch(`https://nextplay-backend.onrender.com/api/recomendacoes/${tipoEndpoint}/${usuarioId}`)
            .then(response => response.json())
            .then(recomendacoes => {
                container.innerHTML = '';
                if (recomendacoes.length === 0) {
                    container.innerHTML = `<p>Avalie mais itens de ${tipoEndpoint} com notas altas!</p>`;
                    return;
                }
                recomendacoes.forEach(item => {
                    let card;
                    if (tipo === 'filmes') card = criarFilmeCard(item, usuarioId);
                    else if (tipo === 'series') card = criarSerieCard(item, usuarioId);
                    else if (tipo === 'musicas') card = criarAlbumCard(item, usuarioId, container);
                    if (card) container.appendChild(card);
                });
            });
    }

    function criarFilmeCard(filme, usuarioId) {
        const card = document.createElement('div');
        card.className = 'filme-card';
        const poster = document.createElement('img');
        poster.src = filme.urlPoster;
        poster.alt = "Pôster do filme " + filme.titulo;
        const titulo = document.createElement('h3');
        titulo.textContent = filme.titulo;
        card.appendChild(poster);
        card.appendChild(titulo);
        const ratingContainer = document.createElement('div');
        ratingContainer.className = 'rating-stars';
        for (let i = 1; i <= 5; i++) {
            const star = document.createElement('span');
            star.innerHTML = '&#9733;';
            star.dataset.nota = 6 - i;
            ratingContainer.appendChild(star);
            star.addEventListener('click', (e) => { e.stopPropagation(); enviarAvaliacao(filme.id, usuarioId, star.dataset.nota, card); });
        }
        card.appendChild(ratingContainer);
        return card;
    }

    function criarSerieCard(serie, usuarioId) {
        const card = document.createElement('div');
        card.className = 'filme-card';
        const poster = document.createElement('img');
        poster.src = serie.urlPoster;
        poster.alt = "Pôster da série " + serie.nome;
        const titulo = document.createElement('h3');
        titulo.textContent = serie.nome;
        card.appendChild(poster);
        card.appendChild(titulo);
        const ratingContainer = document.createElement('div');
        ratingContainer.className = 'rating-stars';
        for (let i = 1; i <= 5; i++) {
            const star = document.createElement('span');
            star.innerHTML = '&#9733;';
            star.dataset.nota = 6 - i;
            ratingContainer.appendChild(star);
            star.addEventListener('click', (e) => { e.stopPropagation(); enviarAvaliacaoSerie(serie.id, usuarioId, star.dataset.nota, card); });
        }
        card.appendChild(ratingContainer);
        return card;
    }

    function exibirArtistas(usuarioId, container) {
        container.innerHTML = `<p>Carregando artistas...</p>`;
        fetch(`https://nextplay-backend.onrender.com/api/artistas`)
            .then(res => res.json()).then(artistas => {
                container.innerHTML = '';
                artistas.forEach(artista => container.appendChild(criarArtistaCard(artista, usuarioId, container)));
            });
    }

    function exibirAlbunsDeArtista(artista, usuarioId, container) {
        container.innerHTML = `<p>Carregando álbuns de ${artista.nome}...</p>`;
        fetch(`https://nextplay-backend.onrender.com/api/artistas/${artista.id}/albuns`)
            .then(res => res.json()).then(albuns => {
                container.innerHTML = '';
                container.appendChild(criarBotaoVoltar(() => exibirArtistas(usuarioId, container)));
                albuns.forEach(album => container.appendChild(criarAlbumCard(album, usuarioId, container)));
            });
    }

    function exibirMusicasDeAlbum(album, usuarioId, container) {
        container.innerHTML = `<p>Carregando músicas de ${album.titulo}...</p>`;
        fetch(`https://nextplay-backend.onrender.com/api/albuns/${album.id}/musicas`)
            .then(res => res.json()).then(musicas => {
                container.innerHTML = '';
                container.appendChild(criarBotaoVoltar(() => exibirAlbunsDeArtista(album.artista, usuarioId, container)));
                musicas.forEach(musica => container.appendChild(criarMusicaCard(musica, usuarioId)));
            });
    }

    function criarBotaoVoltar(acao) {
        const backButton = document.createElement('button');
        backButton.textContent = '← Voltar';
        backButton.className = 'back-button';
        backButton.addEventListener('click', acao);
        return backButton;
    }

    function criarArtistaCard(artista, usuarioId, container) {
        const card = document.createElement('div');
        card.className = 'filme-card artista-card';
        const imagem = document.createElement('img');
        imagem.src = artista.urlImagem;
        imagem.alt = `Foto de ${artista.nome}`;
        imagem.className = 'artista-imagem';
        const nome = document.createElement('h3');
        nome.textContent = artista.nome;
        card.appendChild(imagem);
        card.appendChild(nome);
        card.addEventListener('click', () => exibirAlbunsDeArtista(artista, usuarioId, container));
        return card;
    }

    function criarAlbumCard(album, usuarioId, container) {
        const card = document.createElement('div');
        card.className = 'filme-card album-card';
        const poster = document.createElement('img');
        poster.src = album.urlCapa;
        poster.alt = `Capa do álbum ${album.titulo}`;
        const titulo = document.createElement('h3');
        titulo.textContent = album.titulo;
        card.appendChild(poster);
        card.appendChild(titulo);
        card.addEventListener('click', () => exibirMusicasDeAlbum(album, usuarioId, container));
        return card;
    }

    function criarMusicaCard(musica, usuarioId) {
        const card = document.createElement('div');
        card.className = 'filme-card musica-card';
        const poster = document.createElement('img');
        poster.src = musica.album.urlCapa;
        poster.alt = `Capa do álbum ${musica.album.titulo}`;
        const titulo = document.createElement('h3');
        titulo.textContent = musica.titulo;
        const artista = document.createElement('p');
        artista.className = 'musica-artista';
        artista.textContent = musica.album.artista.nome;
        card.appendChild(poster);
        card.appendChild(titulo);
        card.appendChild(artista);
        if (musica.urlPreview) {
            const previewPlayer = document.createElement('audio');
            previewPlayer.className = 'musica-preview';
            previewPlayer.controls = true;
            previewPlayer.src = musica.urlPreview;
            card.appendChild(previewPlayer);
        }
        const ratingContainer = document.createElement('div');
        ratingContainer.className = 'rating-stars';
        for (let i = 1; i <= 5; i++) {
            const star = document.createElement('span');
            star.innerHTML = '&#9733;';
            star.dataset.nota = 6 - i;
            ratingContainer.appendChild(star);
            star.addEventListener('click', (e) => {
                e.stopPropagation();
                enviarAvaliacaoMusica(musica.id, usuarioId, star.dataset.nota, card);
            });
        }
        card.appendChild(ratingContainer);
        return card;
    }

    function enviarAvaliacao(filmeId, usuarioId, nota, cardElemento) {
        const dadosAvaliacao = { usuarioId: parseInt(usuarioId), nota: parseInt(nota) };
        fetch(`https://nextplay-backend.onrender.com/api/filmes/${filmeId}/avaliar`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dadosAvaliacao) })
            .then(response => { if (response.ok) { alert(`Você avaliou o filme com ${nota} estrelas!`); cardElemento.classList.add('avaliado'); } else { alert('Erro ao salvar avaliação de filme.'); } });
    }
    
    function enviarAvaliacaoSerie(serieId, usuarioId, nota, cardElemento) {
        const dadosAvaliacao = { usuarioId: parseInt(usuarioId), nota: parseInt(nota) };
        fetch(`https://nextplay-backend.onrender.com/api/series/${serieId}/avaliar`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dadosAvaliacao) })
            .then(response => { if (response.ok) { alert(`Você avaliou a série com ${nota} estrelas!`); cardElemento.classList.add('avaliado'); } else { alert('Erro ao salvar avaliação de série.'); } });
    }

    function enviarAvaliacaoMusica(musicaId, usuarioId, nota, cardElemento) {
        const dadosAvaliacao = { usuarioId: parseInt(usuarioId), nota: parseInt(nota) };
        fetch(`https://nextplay-backend.onrender.com/api/musica/${musicaId}/avaliar`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dadosAvaliacao) })
            .then(response => { if (response.ok) { alert(`Você avaliou a música com ${nota} estrelas! A função de recomendações da aba de música ainda não foi adicionada. Enquanto isso, receba suas recomendações de filmes e séries ao final de suas respectivas abas!`); cardElemento.classList.add('avaliado'); } else { alert('Erro ao salvar avaliação de música.'); } });
    }
</script>
    
</body>
</html>