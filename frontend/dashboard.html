<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="img/icone.png" type="image/x-icon">
    <link rel="stylesheet" href="css/style.css">
    <title>NextPlay - Home</title>
</head>
<body>

    <header>
        <a href="index.html" id="link-home">
            <div id="logo">
                <img src="./img/icone.png" alt="">
            </div>
            <div id="nome">
                NextPlay
            </div>
        </a>
        <div id="social-media">
            <a href="https://www.linkedin.com/in/gildojuniorab" target="_blank">
              <img src="./img/linkedin.svg" alt="LinkedIn">  
            </a>
            <a href="https://github.com/jonesbenson94-alt" target="_blank">
                  <img src="./img/github.svg" alt="GitHub">
              </a>
                <a href="https://www.instagram.com/gildo_ts13" target="_blank">
                  <img src="./img/instagram.svg" alt="Instagram">          
                </a>
        </div>
    </header>

    <main>
        <div class="container-principal">
            <h1>Catálogo de Filmes</h1>
            <p>Avalie os filmes que você já assistiu para receber recomendações!</p>
            
            <div id="catalogo-filmes">
                </div>

            <h2 class="titulo-secao">Recomendações para Você</h2>
            <div id="recomendacoes-container">
                </div>
        </div>
    </main>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        const catalogoContainer = document.getElementById('catalogo-filmes');
        const recomendacoesContainer = document.getElementById('recomendacoes-container');
        
        const usuarioId = sessionStorage.getItem('usuarioId');
        if (!usuarioId) {
            window.location.href = 'index.html';
            return;
        }
        catalogoContainer.innerHTML = '<p>Carregando filmes...</p>';
        fetch('http://localhost:8080/api/filmes')
            .then(response => response.json())
            .then(filmes => {
                catalogoContainer.innerHTML = '';
                filmes.forEach(filme => {
                    const card = criarFilmeCard(filme, usuarioId);
                    catalogoContainer.appendChild(card);
                });
            })
            .catch(error => {
                console.error('Erro ao buscar filmes:', error);
                catalogoContainer.innerHTML = '<p style="color: red;">Não foi possível carregar os filmes.</p>';
            });
        recomendacoesContainer.innerHTML = '<p>Calculando recomendações...</p>';
        fetch(`http://localhost:8080/api/recomendacoes/${usuarioId}`)
            .then(response => response.json())
            .then(filmesRecomendados => {
                recomendacoesContainer.innerHTML = '';
                if (filmesRecomendados.length === 0) {
                    recomendacoesContainer.innerHTML = '<p>Avalie mais filmes com 4 ou 5 estrelas para receber recomendações!</p>';
                    return;
                }
                filmesRecomendados.forEach(filme => {
                    const card = criarFilmeCard(filme, usuarioId);
                    recomendacoesContainer.appendChild(card);
                });
            })
            .catch(error => {
                console.error('Erro ao buscar recomendações:', error);
                recomendacoesContainer.innerHTML = '<p style="color: red;">Não foi possível carregar as recomendações.</p>';
            });
    });
    function criarFilmeCard(filme, usuarioId) {
        const card = document.createElement('div');
        card.className = 'filme-card';

        const poster = document.createElement('img');
        poster.src = filme.urlPoster;
        poster.alt = "Pôster do filme " + filme.titulo;

        const titulo = document.createElement('h3');
        titulo.textContent = filme.titulo;
        
        const ratingContainer = document.createElement('div');
        ratingContainer.className = 'rating-stars';

        for (let i = 1; i <= 5; i++) {
            const star = document.createElement('span');
            star.innerHTML = '&#9733;';
            star.dataset.nota = 6 - i;
            ratingContainer.appendChild(star);
            star.addEventListener('click', function() {
                enviarAvaliacao(filme.id, usuarioId, this.dataset.nota, card);
            });
        }
        
        card.appendChild(poster);
        card.appendChild(titulo);
        card.appendChild(ratingContainer);
        return card;
    }
    function enviarAvaliacao(filmeId, usuarioId, nota, cardElemento) {
        const dadosAvaliacao = { usuarioId: parseInt(usuarioId), nota: parseInt(nota) };
        fetch(`http://localhost:8080/api/filmes/${filmeId}/avaliar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dadosAvaliacao)
        })
        .then(response => {
            if(response.ok) {
                alert(`Você avaliou o filme com ${nota} estrelas!`);
                cardElemento.classList.add('avaliado');
            } else {
                alert('Ocorreu um erro ao salvar sua avaliação.');
            }
        });
    }
    </script>
</body>
</html>